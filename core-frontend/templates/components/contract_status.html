<style>
  .contracts-card {
    background: #1a1a1a;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #333;
    margin-bottom: 15px;
  }
  .contracts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #333;
  }
  .contracts-header h2 {
    font-size: 1.1em;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
  }
  .contracts-header h2::before {
    content: "";
    width: 3px;
    height: 16px;
    background: #f59e0b;
    border-radius: 2px;
  }
  .contract-item {
    background: #252525;
    border-radius: 6px;
    margin-bottom: 8px;
    overflow: hidden;
  }
  .contract-item:last-child {
    margin-bottom: 0;
  }
  .contract-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .contract-header:hover {
    background: #2a2a2a;
  }
  .contract-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .contract-name {
    font-weight: 600;
    color: #fff;
  }
  .contract-addr {
    font-family: monospace;
    font-size: 0.7em;
    color: #666;
  }
  .contract-right {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.8em;
  }
  .contract-stat {
    text-align: right;
  }
  .contract-stat .label {
    font-size: 0.7em;
    color: #666;
  }
  .contract-stat .value {
    font-family: monospace;
    color: #6366f1;
  }
  .contract-stat .value.synced {
    color: #4ade80;
  }
  .contract-stat .value.behind {
    color: #fde047;
  }
  .contract-stat .value.error {
    color: #f87171;
  }
  .contract-progress {
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 3px;
    min-width: 50px;
    text-align: center;
  }
  .contract-progress.synced {
    background: #166534;
    color: #4ade80;
  }
  .contract-progress.behind {
    background: #854d0e;
    color: #fde047;
  }
  .contract-progress.error {
    background: #991b1b;
    color: #fca5a5;
  }
  .expand-icon {
    color: #666;
    font-size: 0.8em;
    transition: transform 0.2s;
    margin-left: 8px;
  }
  .contract-item.expanded .expand-icon {
    transform: rotate(180deg);
  }
  .contract-body {
    display: none;
    padding: 12px;
    border-top: 1px solid #333;
  }
  .contract-item.expanded .contract-body {
    display: block;
  }
  .contract-blocks {
    display: flex;
    gap: 16px;
    font-size: 0.75em;
    color: #888;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  .contract-blocks .val {
    color: #6366f1;
    font-family: monospace;
  }
  .contract-tables {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 6px;
  }
  .contract-table-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 10px;
    background: #1a1a1a;
    border-radius: 4px;
    font-size: 0.8em;
    cursor: default;
    transition: background 0.15s;
  }
  .contract-table-row:hover {
    background: #2a2a3a;
  }
  .contract-table-name {
    font-family: monospace;
    color: #e0e0e0;
  }
  .contract-table-count {
    font-family: monospace;
    color: #6366f1;
  }
  .syncing-badge {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.65em;
    background: #854d0e;
    color: #fde047;
    margin-left: 6px;
  }
  .contract-tooltip {
    position: fixed;
    background: rgba(0, 0, 0, 0.95);
    border: 1px solid #444;
    padding: 10px 14px;
    border-radius: 6px;
    font-size: 0.75em;
    font-family: monospace;
    pointer-events: none;
    z-index: 1000;
    max-width: 500px;
    max-height: 400px;
    overflow: auto;
    white-space: pre-wrap;
    line-height: 1.5;
    display: none;
  }
</style>

<div class="contracts-card">
  <div class="contracts-header">
    <h2>协议合约</h2>
  </div>
  <div id="contracts-list"></div>
</div>

<div class="contract-tooltip" id="contract-tooltip"></div>

<script>
(function() {
  const CONTRACTS = [
    {
      name: 'ConditionalTokens',
      addr: '0x4D97DCd97eC945f40cF65F87097ACe5EA0476045',
      start: 4027499,
      tables: ['condition', 'split', 'merge', 'redemption', 'transfer']
    },
    {
      name: 'CTFExchange',
      addr: '0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E',
      start: 35887522,
      tables: ['order_filled', 'token_map']
    },
    {
      name: 'NegRiskCTFExchange',
      addr: '0xC5d563A36AE78145C45a50134d48A1215220f80a',
      start: 51405773,
      tables: []
    },
    {
      name: 'NegRiskAdapter',
      addr: '0xd91E80cF2E7be2e162c6513ceD06f1dD0dA35296',
      start: 50748168,
      tables: ['convert', 'neg_risk_market', 'neg_risk_question']
    }
  ];

  let expandedContracts = new Set();
  let tableCountsCache = {};
  let tooltipCache = {};

  function formatNumber(n) {
    return n.toLocaleString();
  }

  function calcProgress(contract, lastBlock, headBlock) {
    if (lastBlock < contract.start) return 0;
    if (headBlock <= contract.start) return 0;
    return Math.min(100, (lastBlock - contract.start) / (headBlock - contract.start) * 100);
  }

  function getProgressClass(pct) {
    if (pct >= 99.9) return 'synced';
    if (pct >= 90) return 'behind';
    return 'error';
  }

  function getBehindClass(behind) {
    if (behind < 100) return 'synced';
    if (behind < 10000) return 'behind';
    return 'error';
  }

  function toggleContract(name) {
    if (expandedContracts.has(name)) {
      expandedContracts.delete(name);
    } else {
      expandedContracts.add(name);
    }
    renderContracts();
  }

  function renderContracts() {
    const lastBlock = parseInt(document.body.dataset.lastBlock || '0');
    const headBlock = parseInt(document.body.dataset.headBlock || '0');
    const isSyncing = document.body.dataset.isSyncing === 'true';

    const container = document.getElementById('contracts-list');
    let html = '';

    for (const c of CONTRACTS) {
      const isExpanded = expandedContracts.has(c.name);
      const pct = calcProgress(c, lastBlock, headBlock);
      const behind = Math.max(0, headBlock - lastBlock);
      const progressClass = getProgressClass(pct);
      const behindClass = getBehindClass(behind);

      html += `
        <div class="contract-item ${isExpanded ? 'expanded' : ''}" data-contract="${c.name}">
          <div class="contract-header" onclick="window._contractToggle('${c.name}')">
            <div class="contract-left">
              <span class="contract-name">${c.name}</span>
              ${isSyncing && lastBlock >= c.start ? '<span class="syncing-badge">syncing</span>' : ''}
              <span class="contract-addr">${c.addr}</span>
            </div>
            <div class="contract-right">
              <div class="contract-stat">
                <div class="label">Start</div>
                <div class="value">${formatNumber(c.start)}</div>
              </div>
              <div class="contract-stat">
                <div class="label">Behind</div>
                <div class="value ${behindClass}">${formatNumber(behind)}</div>
              </div>
              <span class="contract-progress ${progressClass}">${pct.toFixed(1)}%</span>
              <span class="expand-icon">▼</span>
            </div>
          </div>
          <div class="contract-body">
            <div class="contract-blocks">
              <span>Start: <span class="val">${formatNumber(c.start)}</span></span>
              <span>Last: <span class="val">${formatNumber(lastBlock)}</span></span>
              <span>Head: <span class="val">${formatNumber(headBlock)}</span></span>
            </div>
            ${c.tables.length > 0 ? `
              <div class="contract-tables">
                ${c.tables.map(t => {
                  const count = tableCountsCache[t] || 0;
                  return `
                    <div class="contract-table-row" 
                         data-table="${t}"
                         onmouseenter="window._contractTableHover(event, '${t}')"
                         onmouseleave="window._contractTableLeave()">
                      <span class="contract-table-name">${t}</span>
                      <span class="contract-table-count">${formatNumber(count)}</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : '<div style="color: #666; font-size: 0.8em;">此合约的数据与其他合约共享表</div>'}
          </div>
        </div>
      `;
    }

    container.innerHTML = html;
  }

  async function fetchTableTooltip(tableName) {
    if (tooltipCache[tableName]) {
      return tooltipCache[tableName];
    }

    try {
      const schemaResp = await fetch(`/api/query?q=${encodeURIComponent(`DESCRIBE ${tableName}`)}`);
      const schema = await schemaResp.json();

      const latestResp = await fetch(`/api/query?q=${encodeURIComponent(`SELECT * FROM ${tableName} ORDER BY block_number DESC LIMIT 1`)}`);
      const latest = await latestResp.json();

      let text = `Table: ${tableName}\n\n`;
      text += `Schema:\n`;
      for (const col of schema) {
        text += `  ${col.column_name}: ${col.column_type}\n`;
      }

      if (latest.length > 0) {
        text += `\nLatest row:\n`;
        const row = latest[0];
        for (const [k, v] of Object.entries(row)) {
          let val = v;
          if (typeof v === 'string' && v.length > 40) {
            val = v.slice(0, 40) + '...';
          }
          text += `  ${k}: ${val}\n`;
        }
      } else {
        text += `\n(empty table)`;
      }

      tooltipCache[tableName] = text;
      return text;
    } catch (e) {
      return `Error loading ${tableName}: ${e.message}`;
    }
  }

  let tooltipTimeout = null;

  async function showTableTooltip(event, tableName) {
    const tooltip = document.getElementById('contract-tooltip');
    tooltip.textContent = 'Loading...';
    tooltip.style.display = 'block';

    const rect = event.target.getBoundingClientRect();
    tooltip.style.left = (rect.right + 10) + 'px';
    tooltip.style.top = rect.top + 'px';

    if (tooltip.getBoundingClientRect().right > window.innerWidth - 20) {
      tooltip.style.left = (rect.left - tooltip.offsetWidth - 10) + 'px';
    }

    const text = await fetchTableTooltip(tableName);
    tooltip.textContent = text;
  }

  function hideTableTooltip() {
    if (tooltipTimeout) {
      clearTimeout(tooltipTimeout);
      tooltipTimeout = null;
    }
    document.getElementById('contract-tooltip').style.display = 'none';
  }

  function updateContractTables(tables) {
    for (const t of tables) {
      tableCountsCache[t.name] = t.count;
    }
    renderContracts();
  }

  function updateContractSync(sync) {
    document.body.dataset.lastBlock = sync.last_block || 0;
    document.body.dataset.headBlock = sync.head_block || 0;
    document.body.dataset.isSyncing = sync.is_syncing ? 'true' : 'false';
    renderContracts();
  }

  window._contractToggle = toggleContract;
  window._contractTableHover = function(event, tableName) {
    if (tooltipTimeout) clearTimeout(tooltipTimeout);
    tooltipTimeout = setTimeout(() => showTableTooltip(event, tableName), 200);
  };
  window._contractTableLeave = hideTableTooltip;
  window.updateContractTables = updateContractTables;
  window.updateContractSync = updateContractSync;

  renderContracts();
})();
</script>
