<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Polymarket Explorer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #0f0f0f;
        color: #e0e0e0;
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        text-align: center;
        padding: 20px 0;
        border-bottom: 1px solid #333;
        margin-bottom: 20px;
      }
      header h1 {
        font-size: 2em;
        color: #fff;
        margin-bottom: 5px;
      }
      header p {
        color: #888;
        font-size: 0.9em;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.7em;
        font-weight: 500;
      }
      .badge-success {
        background: #166534;
        color: #4ade80;
      }
      .badge-warning {
        background: #854d0e;
        color: #fde047;
      }
      .badge-error {
        background: #991b1b;
        color: #fca5a5;
      }
    </style>
  </head>
  <body
    data-last-block="{{ sync_state.last_block or 0 }}"
    data-head-block="{{ sync_state.head_block or 0 }}"
    data-is-syncing="{{ 'true' if sync_state.is_syncing else 'false' }}"
  >
    <div class="container">
      <header>
        <h1>Polymarket Explorer</h1>
        <p>Polymarket 链上数据同步与查询</p>
      </header>

      {% include 'components/sync_status.html' %}
    </div>

    <script>
      function formatNumber(n) {
        return n.toLocaleString();
      }

      async function refresh() {
        try {
          const [syncRes, tablesRes] = await Promise.all([
            fetch("/api/sync-state"),
            fetch("/api/tables"),
          ]);
          const sync = await syncRes.json();
          const tables = await tablesRes.json();

          updateSyncStatus(sync);
          updateTables(tables);
        } catch (e) {
          console.error("Refresh failed:", e);
        }
      }

      async function exportAllCSV() {
        const btn = document.getElementById("export-all-btn");
        btn.disabled = true;
        btn.textContent = "导出中...";

        const exportTables = ["order_filled", "split", "merge", "redemption", "convert", "transfer"];
        const results = [];

        try {
          for (const tableName of exportTables) {
            const query = `SELECT * FROM ${tableName} ORDER BY block_number DESC, log_index DESC LIMIT 1000`;
            const resp = await fetch("/api/query?q=" + encodeURIComponent(query));
            const rows = await resp.json();

            if (rows.length > 0) {
              const headers = Object.keys(rows[0]);
              const csvContent = [
                headers.join(","),
                ...rows.map(row => headers.map(h => {
                  let val = row[h];
                  if (val === null) return "";
                  if (typeof val === "string" && (val.includes(",") || val.includes('"') || val.includes("\n"))) {
                    return '"' + val.replace(/"/g, '""') + '"';
                  }
                  return val;
                }).join(","))
              ].join("\n");

              const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
              const link = document.createElement("a");
              link.href = URL.createObjectURL(blob);
              link.download = `${tableName}_${new Date().toISOString().slice(0,10)}.csv`;
              link.click();
              URL.revokeObjectURL(link.href);
              results.push(tableName);

              await new Promise(r => setTimeout(r, 200));
            }
          }

          if (results.length === 0) {
            alert("所有表均无数据");
          }
        } catch (e) {
          console.error("Export failed:", e);
          alert("导出失败: " + e.message);
        } finally {
          btn.disabled = false;
          btn.textContent = "全部导出";
        }
      }

      refresh();
      setInterval(refresh, 3000);
    </script>
  </body>
</html>
